# AFP Architecture Diagram

## AFP System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                           AFP Framework Architecture                        │
│                                                                             │
│  ┌───────────────────────────────┐        ┌───────────────────────────────┐ │
│  │                               │        │                               │ │
│  │           Agent 1             │        │           Agent 2             │ │
│  │                               │        │                               │ │
│  │  ┌───────────────────────┐    │        │  ┌───────────────────────┐    │ │
│  │  │                       │    │        │  │                       │    │ │
│  │  │    Agent Wrapper      │    │        │  │    Agent Wrapper      │    │ │
│  │  │                       │    │        │  │                       │    │ │
│  │  └───────────┬───────────┘    │        │  └───────────┬───────────┘    │ │
│  │              │                │        │              │                │ │
│  └──────────────┼────────────────┘        └──────────────┼────────────────┘ │
│                 │                                         │                  │
│                 │                                         │                  │
│  ┌──────────────▼─────────────────────────────────────────▼──────────────┐  │
│  │                                                                        │  │
│  │                         Communication Bus                              │  │
│  │                                                                        │  │
│  │  ┌──────────────────┐  ┌─────────────────┐  ┌─────────────────────┐   │  │
│  │  │                  │  │                 │  │                     │   │  │
│  │  │  Message Router  │  │  Subscription   │  │  Message Delivery   │   │  │
│  │  │                  │  │    Manager      │  │       System        │   │  │
│  │  └──────────────────┘  └─────────────────┘  └─────────────────────┘   │  │
│  │                                                                        │  │
│  │  ┌──────────────────┐  ┌─────────────────┐  ┌─────────────────────┐   │  │
│  │  │                  │  │                 │  │                     │   │  │
│  │  │ Response Queues  │  │  Circuit        │  │  Message Cache      │   │  │
│  │  │                  │  │    Breaker      │  │                     │   │  │
│  │  └──────────────────┘  └─────────────────┘  └─────────────────────┘   │  │
│  │                                                                        │  │
│  └────────────────────────────────────┬───────────────────────────────────┘  │
│                                       │                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                                   │                                     │ │
│  │                          AFP Orchestrator                              │ │
│  │                                   │                                     │ │
│  │  ┌────────────────┐  ┌────────────▼───────────┐  ┌──────────────────┐  │ │
│  │  │                │  │                        │  │                  │  │ │
│  │  │ Agent Registry │  │ Message Classification │  │ Routing Policies │  │ │
│  │  │                │  │                        │  │                  │  │ │
│  │  └────────────────┘  └────────────────────────┘  └──────────────────┘  │ │
│  │                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Message Flow Sequence

```
┌─────────┐          ┌─────────────────┐          ┌─────────┐          ┌─────────┐
│ Agent A │          │ Communication   │          │ Agent B │          │ Agent C │
└────┬────┘          │      Bus        │          └────┬────┘          └────┬────┘
     │               └────────┬────────┘               │                    │
     │  1. Create Message     │                        │                    │
     │ ───────────────────────>                        │                    │
     │                        │                        │                    │
     │                        │  2. Route Message      │                    │
     │                        │ ──────────────────────>│                    │
     │                        │                        │                    │
     │                        │                        │  3. Process        │
     │                        │                        │  & Generate        │
     │                        │                        │  Response          │
     │                        │                        │ ─────┐             │
     │                        │                        │      │             │
     │                        │                        │ <────┘             │
     │                        │                        │                    │
     │                        │  4. Return Response    │                    │
     │                        │ <──────────────────────│                    │
     │                        │                        │                    │
     │  5. Deliver Response   │                        │                    │
     │ <───────────────────────                        │                    │
     │                        │                        │                    │
     │  6. Create Follow-up   │                        │                    │
     │     Message            │                        │                    │
     │ ───────────────────────>                        │                    │
     │                        │                        │                    │
     │                        │  7. Route to multiple  │                    │
     │                        │     recipients         │                    │
     │                        │ ──────────────────────>│                    │
     │                        │                        │                    │
     │                        │  7. Route to multiple  │                    │
     │                        │     recipients         │                    │
     │                        │ ────────────────────────────────────────────>
     │                        │                        │                    │
     │                        │                        │  8. Process        │
     │                        │                        │     Message        │
     │                        │                        │ ─────┐             │
     │                        │                        │      │             │
     │                        │                        │ <────┘             │
     │                        │                        │                    │
     │                        │                        │                    │  8. Process
     │                        │                        │                    │     Message
     │                        │                        │                    │ ─────┐
     │                        │                        │                    │      │
     │                        │                        │                    │ <────┘
```

## Communication Patterns

### 1. Direct Agent-to-Agent Communication

```
┌─────────┐                                           ┌─────────┐
│ Agent A │                                           │ Agent B │
└────┬────┘                                           └────┬────┘
     │                                                     │
     │  AFPMessage(sender="A", recipients=["B"], ...)     │
     │ ─────────────────────────────────────────────────> │
     │                                                     │
     │           Response(content="Result", ...)          │
     │ <───────────────────────────────────────────────── │
```

### 2. Broadcast Communication

```
┌─────────┐          ┌─────────┐          ┌─────────┐
│ Agent A │          │ Agent B │          │ Agent C │
└────┬────┘          └────┬────┘          └────┬────┘
     │                    │                    │
     │  Broadcast         │                    │
     │ ───────────────────┼───────────────────>│
     │                    │                    │
     │  Broadcast         │                    │
     │ ───────────────────>                    │
```

### 3. Subscription-Based Communication

```
┌─────────┐          ┌─────────────────┐          ┌─────────┐
│ Agent A │          │     Topic:      │          │ Agent B │
└────┬────┘          │  "calculation"  │          └────┬────┘
     │               └────────┬────────┘               │
     │                        │                        │
     │                        │     Subscribe          │
     │                        │ <──────────────────────│
     │                        │                        │
     │     Publish            │                        │
     │ ───────────────────────>                        │
     │                        │                        │
     │                        │     Notify             │
     │                        │ ──────────────────────>│
```

## AFP Message Structure

```
┌───────────────────────────────────────────────────────────────────┐
│                           AFP Message                              │
├───────────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────┐   │
│ │   Header Info   │ │    Content      │ │     Metadata        │   │
│ │                 │ │                 │ │                     │   │
│ │ - message_id    │ │ - content_type  │ │ - timestamp         │   │
│ │ - sender        │ │ - content       │ │ - ttl               │   │
│ │ - recipients    │ │                 │ │ - priority          │   │
│ │ - parent_id     │ │                 │ │ - trace_path        │   │
│ └─────────────────┘ └─────────────────┘ │ - delivery_guarantee │   │
│                                         │ - schema             │   │
│                                         └─────────────────────┘   │
└───────────────────────────────────────────────────────────────────┘
``` 
